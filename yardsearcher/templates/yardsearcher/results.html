    {% extends 'yardsearcher/base.html' %}
    {% load static %}
    {% block extra_links %}
    <link rel="stylesheet" href="{% static 'css/results.css' %}?v={{tz}}" />
    <link rel="stylesheet" href="{% static 'css/leaflet.css' %}?v={{tz}}" />

    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    
    {% endblock %}
    {% block main_content %}
        <!-- Search Bar -->
        <div class="bg-card/30 border-b border-border">
            <div class="container mx-auto px-4 py-6">
                <div class="flex gap-3 items-center">
                    <div class="relative flex-1">
                        <form method="get">
                            <input
                                type="text"
                                id="search-input"
                                name="q"
                                placeholder="Search by make, model, or year..."
                                value="{{query}}"
                                class="w-full pl-4 pr-12 h-14 text-base bg-background border-2 border-border rounded-lg focus:border-primary focus:outline-none transition-colors text-foreground"
                                required
                            />
                            <button
                                type="submit"
                                id="clear-search"
                                class=" absolute right-4 top-1/2 transform -translate-y-1/2 text-muted-foreground hover:text-foreground transition-colors"
                            >
                                <svg class="w-5 h-5 " fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            </button>
                        </form>
                    </div>
                    <button
                        id="filters-toggle"
                        class="hidden h-14 px-6 bg-muted border-2 border-border text-foreground rounded-lg hover:bg-muted/80 transition-colors font-semibold"
                    >
                        <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                        </svg>
                        Filters
                    </button>
                </div>

                <!-- Filters Panel -->
                <div id="filters-panel" class="hidden mt-4 fade-in">
                    <div class="p-6 bg-card border-2 border-border rounded-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-foreground">Advanced Filters</h3>
                            <button
                                id="clear-filters"
                                class="text-sm text-muted-foreground hover:text-foreground transition-colors"
                            >
                                <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                Clear All
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="filter-year" class="block text-foreground font-semibold mb-2">Year</label>
                                <input
                                    type="text"
                                    id="filter-year"
                                    placeholder="e.g., 2020"
                                    class="w-full px-4 py-2 bg-background border-2 border-border rounded-lg focus:border-primary focus:outline-none"
                                />
                            </div>
                            <div>
                                <label for="filter-make" class="block text-foreground font-semibold mb-2">Make</label>
                                <input
                                    type="text"
                                    id="filter-make"
                                    placeholder="e.g., Ford"
                                    class="w-full px-4 py-2 bg-background border-2 border-border rounded-lg focus:border-primary focus:outline-none"
                                />
                            </div>
                            <div>
                                <label for="filter-model" class="block text-foreground font-semibold mb-2">Model</label>
                                <input
                                    type="text"
                                    id="filter-model"
                                    placeholder="e.g., F-150"
                                    class="w-full px-4 py-2 bg-background border-2 border-border rounded-lg focus:border-primary focus:outline-none"
                                />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container mx-auto px-4 py-8">
            <div class="flex flex-col lg:grid lg:grid-cols-2 gap-8">
                <!-- Map Section -->
                <div class="w-full lg:sticky lg:top-32 self-start">
                    <div class="p-4 bg-card border-2 border-border rounded-lg">
                        {% if fetched_yard_data|length > 0 %}
                            <div class="mb-4">
                                <h2 class="text-xl font-bold text-foreground flex items-center gap-2">
                                    <span class="text-primary">üìç</span>
                                    Junkyard Locations
                                </h2>
                                <p class="text-sm text-muted-foreground mt-1">
                                    Click markers to view inventory
                                </p>
                            </div>
                            <div id="map" class="h-[500px] lg:h-[600px] rounded-lg z-0 border-2 border-border "></div>
                        {% else %}
                            <img src="{% static '/noresult.png'%}"/>
                            <div id="map" class="hidden "></div>
                        {% endif %}
                    </div>
                </div>

                <!-- Inventory Tables Section -->
                <div id="inventory-container" class="space-y-6">
                    {% for yard in fetched_yard_data %}
                    
                        <div id="inventory-{{ yard.meta.junkyard_id }}" class="overflow-hidden border-2 rounded-lg transition-all duration-300 scroll-mt-8 border-border hover:border-primary/50">
                            <!-- Header -->
                            <div class="bg-gradient-to-r from-card to-muted p-4 cursor-pointer select-none" onclick="toggleTable({{ yard.meta.junkyard_id }})">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-4">
                                        <div>
                                            <h3 class="text-base lg:2xl font-bold text-foreground mb-1">
                                                {{ yard.meta.name|capfirst }}
                                            </h3>
                                            <div class="flex items-center gap-2 text-sm text-muted-foreground">
                                                <span class="hidden md:visible">üìç</span>
                                                {{ yard.meta.address|capfirst }}, {{ yard.meta.city|capfirst }}, {{ yard.meta.state }}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="hidden md:visible px-4 py-2 bg-secondary text-secondary-foreground rounded-md text-base font-medium">
                                            <span class="hidden mr-2">üöó</span>
                                            {% if yard.num_results == 1 %}
                                                1 Vechicle
                                            {% else %}
                                                {{ yard.num_results }} Vechicles
                                            {% endif %}
                                        </div>
                                        <svg id="chevron-{{yard.meta.junkyard_id}}" class="w-6 h-6 transition-transform transition-fill chevron" fill="none" stroke="currentColor"   viewBox="0 0 640 640" style="transform: rotate(-180deg);">
                                            <path d="M480 544C515.3 544 544 515.3 544 480L544 160C544 124.7 515.3 96 480 96L160 96C124.7 96 96 124.7 96 160L96 480C96 515.3 124.7 544 160 544L480 544zM320 416C313.3 416 307 413.2 302.4 408.3L198.4 296.3C191.9 289.3 190.2 279.1 194 270.4C197.8 261.7 206.5 256 216 256L424 256C433.5 256 442.2 261.7 446 270.4C449.8 279.1 448.1 289.3 441.6 296.3L337.6 408.3C333.1 413.2 326.7 416 320 416z"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <!-- Table -->
                            <div id="table-{{yard.meta.junkyard_id}}" class="hidden fade-in">
                                <div class="overflow-x-auto">
                                    <table class="w-full">
                                        <thead class="bg-muted/50" >
                                            <tr data-yardId="{{yard.meta.junkyard_id}}">
                                                <th class="px-6 py-3 text-left font-bold text-foreground" onclick="sortInventory(this)" data-isusing="false" data-order="" data-sortBy="year" >
                                                    <span>Year</span>
                                                    <svg
                                                        viewBox="0 0 640 640"
                                                        class="w-4 h-5 inline ml-2"
                                                        version="1.1"
                                                        xmlns="http://www.w3.org/2000/svg"
                                                    >
                                                    <!--!Font Awesome Pro v7.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2026 Fonticons, Inc.-->
                                                        <path
                                                            d="m 130.4,371.7 c -5,12 -2.2,25.7 6.9,34.9 l 160,160 c 12.5,12.5 32.8,12.5 45.3,0 l 160,-160 c 9.2,-9.2 11.9,-22.9 6.9,-34.9 -5,-12 -16.6,-19.7 -29.5,-19.7 H 160 c -12.9,0 -24.6,7.8 -29.6,19.8 z"
                                                            class="sort-caret"/>
                                                        <path
                                                            d="m 130.4,268.2 c 5,12 16.6,19.8 29.6,19.8 h 320 c 12.9,0 24.6,-7.8 29.6,-19.8 5,-12 2.2,-25.7 -6.9,-34.9 l -160,-160 c -12.5,-12.5 -32.8,-12.5 -45.3,0 l -160,160 c -9.2,9.2 -11.9,22.9 -6.9,34.9 z"
                                                            class="sort-caret" />
                                                    </svg>
                                                </th>
                                                <th class="px-6 py-3 text-left font-bold text-foreground" onclick="sortInventory(this)" data-isusing="false" data-order="" data-sortBy="make" >
                                                    <span>Make</span>
                                                    <svg
                                                        viewBox="0 0 640 640"
                                                        class="w-4 h-5 inline ml-3 "
                                                        version="1.1"
                                                        xmlns="http://www.w3.org/2000/svg"
                                                    >
                                                    <!--!Font Awesome Pro v7.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2026 Fonticons, Inc.-->
                                                        <path
                                                            d="m 130.4,371.7 c -5,12 -2.2,25.7 6.9,34.9 l 160,160 c 12.5,12.5 32.8,12.5 45.3,0 l 160,-160 c 9.2,-9.2 11.9,-22.9 6.9,-34.9 -5,-12 -16.6,-19.7 -29.5,-19.7 H 160 c -12.9,0 -24.6,7.8 -29.6,19.8 z"
                                                            class="sort-caret"/>
                                                        <path
                                                            d="m 130.4,268.2 c 5,12 16.6,19.8 29.6,19.8 h 320 c 12.9,0 24.6,-7.8 29.6,-19.8 5,-12 2.2,-25.7 -6.9,-34.9 l -160,-160 c -12.5,-12.5 -32.8,-12.5 -45.3,0 l -160,160 c -9.2,9.2 -11.9,22.9 -6.9,34.9 z"
                                                            class="sort-caret" />
                                                    </svg>
                                                </th>
                                                <th class="px-6 py-3 text-left font-bold text-foreground" onclick="sortInventory(this)" data-isusing="false" data-order="" data-sortBy="model" >
                                                    <span>Model</span>
                                                    <svg
                                                        viewBox="0 0 640 640"
                                                        class="w-4 h-5 inline ml-3 "
                                                        version="1.1"
                                                        xmlns="http://www.w3.org/2000/svg"
                                                    >
                                                    <!--!Font Awesome Pro v7.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2026 Fonticons, Inc.-->
                                                        <path
                                                            d="m 130.4,371.7 c -5,12 -2.2,25.7 6.9,34.9 l 160,160 c 12.5,12.5 32.8,12.5 45.3,0 l 160,-160 c 9.2,-9.2 11.9,-22.9 6.9,-34.9 -5,-12 -16.6,-19.7 -29.5,-19.7 H 160 c -12.9,0 -24.6,7.8 -29.6,19.8 z"
                                                            class="sort-caret"/>
                                                        <path
                                                            d="m 130.4,268.2 c 5,12 16.6,19.8 29.6,19.8 h 320 c 12.9,0 24.6,-7.8 29.6,-19.8 5,-12 2.2,-25.7 -6.9,-34.9 l -160,-160 c -12.5,-12.5 -32.8,-12.5 -45.3,0 l -160,160 c -9.2,9.2 -11.9,22.9 -6.9,34.9 z"
                                                            class="sort-caret" />
                                                    </svg>
                                                </th>
                                                <th class="px-6 py-3 text-left font-bold text-foreground" onclick="sortInventory(this)" data-isusing="false" data-order="" data-sortBy="row" >
                                                    <span>Row</span>
                                                    <svg
                                                        viewBox="0 0 640 640"
                                                        class="w-4 h-5 inline ml-3 "
                                                        version="1.1"
                                                        xmlns="http://www.w3.org/2000/svg"
                                                    >
                                                    <!--!Font Awesome Pro v7.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2026 Fonticons, Inc.-->
                                                        <path
                                                            d="m 130.4,371.7 c -5,12 -2.2,25.7 6.9,34.9 l 160,160 c 12.5,12.5 32.8,12.5 45.3,0 l 160,-160 c 9.2,-9.2 11.9,-22.9 6.9,-34.9 -5,-12 -16.6,-19.7 -29.5,-19.7 H 160 c -12.9,0 -24.6,7.8 -29.6,19.8 z"
                                                            class="sort-caret"/>
                                                        <path
                                                            d="m 130.4,268.2 c 5,12 16.6,19.8 29.6,19.8 h 320 c 12.9,0 24.6,-7.8 29.6,-19.8 5,-12 2.2,-25.7 -6.9,-34.9 l -160,-160 c -12.5,-12.5 -32.8,-12.5 -45.3,0 l -160,160 c -9.2,9.2 -11.9,22.9 -6.9,34.9 z"
                                                            class="sort-caret" />
                                                    </svg>
                                                </th>
                                                {% if yard.results.last.space %}
                                                    <th class="px-6 py-3 text-left font-bold text-foreground" onclick="sortInventory(this)" data-isusing="false" data-order="" data-sortBy="space" >
                                                        <span>Space</span>
                                                        <svg
                                                        viewBox="0 0 640 640"
                                                        class="w-4 h-5 inline ml-3 "
                                                        version="1.1"
                                                        xmlns="http://www.w3.org/2000/svg"
                                                    >
                                                    <!--!Font Awesome Pro v7.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2026 Fonticons, Inc.-->
                                                        <path
                                                            d="m 130.4,371.7 c -5,12 -2.2,25.7 6.9,34.9 l 160,160 c 12.5,12.5 32.8,12.5 45.3,0 l 160,-160 c 9.2,-9.2 11.9,-22.9 6.9,-34.9 -5,-12 -16.6,-19.7 -29.5,-19.7 H 160 c -12.9,0 -24.6,7.8 -29.6,19.8 z"
                                                            class="sort-caret"/>
                                                        <path
                                                            d="m 130.4,268.2 c 5,12 16.6,19.8 29.6,19.8 h 320 c 12.9,0 24.6,-7.8 29.6,-19.8 5,-12 2.2,-25.7 -6.9,-34.9 l -160,-160 c -12.5,-12.5 -32.8,-12.5 -45.3,0 l -160,160 c -9.2,9.2 -11.9,22.9 -6.9,34.9 z"
                                                            class="sort-caret" />
                                                    </svg>
                                                    </th>
                                                {% endif %}
                                                {% if yard.results.0.vin %}
                                                    <th class="px-6 py-3 text-left font-bold text-foreground" onclick="sortInventory(this)" data-isusing="false" data-order="" data-sortBy="vin" >
                                                        <span>VIN</span>
                                                        <svg
                                                        viewBox="0 0 640 640"
                                                        class="w-4 h-5 inline ml-3 "
                                                        version="1.1"
                                                        xmlns="http://www.w3.org/2000/svg"
                                                    >
                                                    <!--!Font Awesome Pro v7.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2026 Fonticons, Inc.-->
                                                        <path
                                                            d="m 130.4,371.7 c -5,12 -2.2,25.7 6.9,34.9 l 160,160 c 12.5,12.5 32.8,12.5 45.3,0 l 160,-160 c 9.2,-9.2 11.9,-22.9 6.9,-34.9 -5,-12 -16.6,-19.7 -29.5,-19.7 H 160 c -12.9,0 -24.6,7.8 -29.6,19.8 z"
                                                            class="sort-caret"/>
                                                        <path
                                                            d="m 130.4,268.2 c 5,12 16.6,19.8 29.6,19.8 h 320 c 12.9,0 24.6,-7.8 29.6,-19.8 5,-12 2.2,-25.7 -6.9,-34.9 l -160,-160 c -12.5,-12.5 -32.8,-12.5 -45.3,0 l -160,160 c -9.2,9.2 -11.9,22.9 -6.9,34.9 z"
                                                            class="sort-caret" />
                                                    </svg>
                                                    </th>
                                                {% endif %}
                                                {% if yard.results.0.color %}
                                                    <th class="px-6 py-3 text-left font-bold text-foreground" onclick="sortInventory(this)" data-isusing="false" data-order="" data-sortBy="color" >
                                                        <span>Color</span>
                                                        <svg
                                                        viewBox="0 0 640 640"
                                                        class="w-4 h-5 inline ml-3 "
                                                        version="1.1"
                                                        xmlns="http://www.w3.org/2000/svg"
                                                    >
                                                    <!--!Font Awesome Pro v7.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2026 Fonticons, Inc.-->
                                                        <path
                                                            d="m 130.4,371.7 c -5,12 -2.2,25.7 6.9,34.9 l 160,160 c 12.5,12.5 32.8,12.5 45.3,0 l 160,-160 c 9.2,-9.2 11.9,-22.9 6.9,-34.9 -5,-12 -16.6,-19.7 -29.5,-19.7 H 160 c -12.9,0 -24.6,7.8 -29.6,19.8 z"
                                                            class="sort-caret"/>
                                                        <path
                                                            d="m 130.4,268.2 c 5,12 16.6,19.8 29.6,19.8 h 320 c 12.9,0 24.6,-7.8 29.6,-19.8 5,-12 2.2,-25.7 -6.9,-34.9 l -160,-160 c -12.5,-12.5 -32.8,-12.5 -45.3,0 l -160,160 c -9.2,9.2 -11.9,22.9 -6.9,34.9 z"
                                                            class="sort-caret" />
                                                    </svg>
                                                    </th>
                                                {% endif %}
                                                <th class="px-6 py-3 text-left font-bold text-foreground" onclick="sortInventory(this)" data-isusing="false" data-order="" data-sortBy="available_date" >
                                                   <span>Entry Date</span>
                                                   <svg
                                                        viewBox="0 0 640 640"
                                                        class="w-4 h-5 inline ml-3 "
                                                        version="1.1"
                                                        xmlns="http://www.w3.org/2000/svg"
                                                    >
                                                    <!--!Font Awesome Pro v7.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2026 Fonticons, Inc.-->
                                                        <path
                                                            d="m 130.4,371.7 c -5,12 -2.2,25.7 6.9,34.9 l 160,160 c 12.5,12.5 32.8,12.5 45.3,0 l 160,-160 c 9.2,-9.2 11.9,-22.9 6.9,-34.9 -5,-12 -16.6,-19.7 -29.5,-19.7 H 160 c -12.9,0 -24.6,7.8 -29.6,19.8 z"
                                                            class="sort-caret"/>
                                                        <path
                                                            d="m 130.4,268.2 c 5,12 16.6,19.8 29.6,19.8 h 320 c 12.9,0 24.6,-7.8 29.6,-19.8 5,-12 2.2,-25.7 -6.9,-34.9 l -160,-160 c -12.5,-12.5 -32.8,-12.5 -45.3,0 l -160,160 c -9.2,9.2 -11.9,22.9 -6.9,34.9 z"
                                                            class="sort-caret" />
                                                    </svg>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbody-{{yard.meta.junkyard_id}}">
                                            {% for vehicle in yard.results %}
                                                <tr class="border-t border-border hover:bg-muted/50 transition-colors cursor-pointer group">
                                                    <td class="px-6 py-3 text-foreground">{{ vehicle.year }}</td>
                                                    <td class="px-6 py-3 text-foreground">
                                                        {{ vehicle.make|upper }}
                                                    </td>
                                                    <td class="px-6 py-3 text-foreground">{{ vehicle.model|upper }}</td>
                                                    {% if vehicle.row > 0 %}
                                                        <td class="px-6 py-3 font-mono text-sm text-muted-foreground group-hover:text-foreground transition-colors">{{ vehicle.row }}</td>
                                                    {% else %}
                                                        <td class="px-6 py-3 font-mono text-sm text-muted-foreground group-hover:text-foreground transition-colors">-</td>

                                                    {% endif %}
                                                    {% if yard.results.last.space and vehicle.space %}
                                                        <td class="px-6 py-3 font-mono text-sm text-muted-foreground group-hover:text-foreground transition-colors">{{ vehicle.space }}</td>
                                                    {% elif yard.results.last.space and not vehicle.space %}
                                                        <td class="px-6 py-3 font-mono text-sm text-muted-foreground group-hover:text-foreground transition-colors">-</td>
                                                    {% endif %}
                                                    {% if vehicle.vin %}
                                                        <td class="px-6 py-3 font-mono text-sm text-muted-foreground group-hover:text-foreground transition-colors">{{ vehicle.vin }}</td>
                                                    {% endif %}
                                                    {% if vehicle.color %}
                                                        <td class="px-6 py-3 font-mono text-sm text-muted-foreground group-hover:text-foreground transition-colors">{{ vehicle.color }}</td>
                                                    {% endif %}
                                                    <td class="px-6 py-3 font-mono text-sm text-muted-foreground group-hover:text-foreground transition-colors">{{ vehicle.available_date }}</td>
                                                    
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="bg-muted/30 px-6 py-4 border-t border-border">
                                    <p class="text-sm text-muted-foreground">
                                        Found <span class="font-semibold text-foreground">{{ yard.num_results }}</span> vehicles from {{ yard.meta.name|capfirst }}
                                    </p>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="border-t border-border bg-card/30 mt-16">
            <div class="container mx-auto px-4 py-8 text-center flex flex-col gap-4">
                <div class="flex justify-center items-center gap-4">
                    <div class="flex px-3 py-1.5 bg-card border-primary text-secondary-foreground rounded-md text-sm font-medium">
                        <span class=" mr-1"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" class="fill-current text-primary/80 w-5 h-5"><!--!Font Awesome Free v7.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc.--><path d="M320 48C337.7 48 352 62.3 352 80L352 98.3C450.1 112.3 527.7 189.9 541.7 288L560 288C577.7 288 592 302.3 592 320C592 337.7 577.7 352 560 352L541.7 352C527.7 450.1 450.1 527.7 352 541.7L352 560C352 577.7 337.7 592 320 592C302.3 592 288 577.7 288 560L288 541.7C189.9 527.7 112.3 450.1 98.3 352L80 352C62.3 352 48 337.7 48 320C48 302.3 62.3 288 80 288L98.3 288C112.3 189.9 189.9 112.3 288 98.3L288 80C288 62.3 302.3 48 320 48zM160 320C160 408.4 231.6 480 320 480C408.4 480 480 408.4 480 320C480 231.6 408.4 160 320 160C231.6 160 160 231.6 160 320zM320 224C373 224 416 267 416 320C416 373 373 416 320 416C267 416 224 373 224 320C224 267 267 224 320 224z"/></svg></span>
                        <span id="yard-count">{{ total_yards }} Yards</span>

                    </div>
                    <div class="flex px-3 py-1.5 bg-card border-primary text-secondary-foreground rounded-md text-sm font-medium">
                        <span class=" mr-1"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"  class="fill-current text-primary/80 w-5 h-5"><!--!Font Awesome Free v7.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc.--><path d="M199.2 181.4L173.1 256L466.9 256L440.8 181.4C436.3 168.6 424.2 160 410.6 160L229.4 160C215.8 160 203.7 168.6 199.2 181.4zM103.6 260.8L138.8 160.3C152.3 121.8 188.6 96 229.4 96L410.6 96C451.4 96 487.7 121.8 501.2 160.3L536.4 260.8C559.6 270.4 576 293.3 576 320L576 512C576 529.7 561.7 544 544 544L512 544C494.3 544 480 529.7 480 512L480 480L160 480L160 512C160 529.7 145.7 544 128 544L96 544C78.3 544 64 529.7 64 512L64 320C64 293.3 80.4 270.4 103.6 260.8zM192 368C192 350.3 177.7 336 160 336C142.3 336 128 350.3 128 368C128 385.7 142.3 400 160 400C177.7 400 192 385.7 192 368zM480 400C497.7 400 512 385.7 512 368C512 350.3 497.7 336 480 336C462.3 336 448 350.3 448 368C448 385.7 462.3 400 480 400z"/></svg></span>
                        <span id="vehicle-count">{{ total_vehicles }} Vehicles</span>
                    </div>
                </div>
                <p class="text-foreground">
                    How did I do?  <a href="{% url 'add_review_urlpattern' %}" class="no-underline hover:underline text-primary/95">Let me know</a>
                </p>
                <p class="text-foreground">
                    Built by  <a href="https://linkedin.com/in/tyrese-c00k" class="no-underline hover:underline text-primary/80">Ty </a>
                </p>
            </div>
        </footer>
    
    {% endblock %} 
    {% block extra_scripts %}
        <!-- Leaflet JS -->
        <script src="{% static 'js/leaflet.js' %}?v={{ tz }}"></script> 
        {{ yard_data_json|json_script:"yard_data"}}
        <script src="{% static 'js/plotJunkyards.js' %}?v={{ tz }}" defer></script> 
        <script>
            function toggleTable(junkyardId, justshow = false) {
                const table = document.getElementById(`table-${junkyardId}`);
                const chevron = document.getElementById(`chevron-${junkyardId}`);
                
                if ( justshow || table.classList.contains('hidden')) {
                    table.classList.remove('hidden');
                    chevron.classList.add('chevron-opened')
                    chevron.style.transform = 'rotate(0deg)';
                } else {
                    table.classList.add('hidden');
                    chevron.classList.remove('chevron-opened')
                    chevron.style.transform = 'rotate(-180deg)';
                }
            }

        </script>
        <script>
            const querySearchURL = window.location.search;
            const urlParams = new URLSearchParams(querySearchURL);
            const q = urlParams.get('q');
            const url = "{% url 'api_sort_table_urlpattern' %}";

            function get_api_url(th){
                let sortby = th.dataset['sortby'];
                let order = th.dataset['order'];
                let yardId = th.parentNode.dataset['yardid'];
                console.log(`Params for api:\n yardId: ${yardId} \n sortby: "${sortby}" \n order: "${order}" \n q: "${q}"`);
                return encodeURI(`${url}?q=${q}&sortBy=${sortby}&order=${order}&yardId=${yardId}`)
            }
            async function sortInventory(th) {
                try {
                    const api_url = get_api_url(th);
                    const response = await fetch(api_url);
                    if (!response.ok){
                        throw new Error(`Response status: ${response.status}`);
                    }

                    const api_result = await response.json();
                    if (!api_result.ok){
                        throw new Error(`API Usage Error: ${api_result.msg}`);
                    }
                    rebuildTableBody(api_result);
                    toggleOrder(th);
                    
                } catch (error) {
                    console.error(error.message);
                }
            }

            function toggleOrder(th) {
                order_state = th.dataset['order'];
                yardId = th.parentNode.dataset['yardid'];

                // Dim the one other th  that's in use if it exists
                last_active_th = document.querySelector(`tr[data-yardid="${yardId}"] th[data-isusing="true"]`);
                if (last_active_th != null)
                    last_active_th.dataset['isusing'] = "false";

                // Change states of the passed th element
                th.dataset['isusing'] = "true";
                th.dataset['order'] = (order_state == "-") ? "":"-";
            }

            function get_inventory_keys(yardId) {
                let inventory_keys = [];
                document.querySelectorAll(`#table-${yardId} th`).forEach(th => {
                     inventory_keys.push(th.dataset['sortby']);
                });
                return inventory_keys
            }

            function createTableRow(vehicle, valid_fields) {
                tr = document.createElement('tr');
                tr.className = 'border-t border-border hover:bg-muted/50 transition-colors cursor-pointer group';
                foreground_fields = ['year','make','model'];
                let td_class = '';
                valid_fields.map(field => { 
                    let td_html = vehicle[field];
                    if (foreground_fields.includes(field)) {
                        // Use this class
                        td_class = 'px-6 py-3 text-foreground uppercase';
                    } else {
                        td_class = 'px-6 py-3 font-mono text-sm text-muted-foreground group-hover:text-foreground transition-colors';
                    }
                    tr.innerHTML += `<td class="${td_class}">${td_html}</td>`;
                });
                return tr
            }

            function populateTableBody(tableBody, vehicles, valid_fields) {
                vehicles.map(vehicle => { 
                    tableRow = createTableRow(vehicle, valid_fields);
                    tableBody.appendChild(tableRow);
                });
            }
            function rebuildTableBody(api_result) {
                try {
                    const yardId = api_result['yardId'];
                    const tbody = document.querySelector(`#tbody-${yardId}`);
                    const vehicles = api_result['vehicles'];
                    // Collect field names from ths to determine what fields to extract from api
                    const inventory_keys = get_inventory_keys(yardId); 
                    
                    while(tbody.firstChild)
                        tbody.removeChild(tbody.firstChild)
                    // Turn vehicles into a table row
                    populateTableBody(tableBody=tbody, vehicles, valid_fields=inventory_keys);

                } catch (error) {
                    console.error(` Whoops! rebuildTableBody failed: ${error.message}`);
                }
                
            }
            
        </script>
    {% endblock %}